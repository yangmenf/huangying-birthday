<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç”Ÿæ—¥å¿«ä¹ï¼Œé»„é¢–ï¼ğŸ‚</title>
    
    <!-- å¼•å…¥å¤–éƒ¨åº“ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;700&family=Orbitron:wght@400;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary: #ff6b6b;
            --secondary: #feca57;
            --accent: #48dbfb;
            --glass-bg: rgba(255, 255, 255, 0.1);
            --glass-border: rgba(255, 255, 255, 0.2);
            --text-color: #ffffff;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            user-select: none;
            -webkit-user-drag: none;
        }
        
        body {
            overflow: hidden;
            background: #020205;
            font-family: 'Noto Sans SC', sans-serif;
            color: var(--text-color);
            height: 100vh;
            width: 100vw;
            perspective: 1000px;
        }

        /* åŠ¨æ€æ˜Ÿç©ºèƒŒæ™¯ */
        .stars-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 110%;
            height: 110%;
            z-index: -1;
            background: radial-gradient(ellipse at bottom, #1b2735 0%, #090a0f 100%);
            overflow: hidden;
            overflow: hidden;
            transition: transform 0.1s linear;
            pointer-events: none; /* Ensure background never captures clicks */
        }

        .star {
            position: absolute;
            background: white;
            border-radius: 50%;
            animation: twinkle var(--duration) infinite ease-in-out;
            opacity: 0;
        }

        @keyframes twinkle {
            0%, 100% { opacity: 0; transform: scale(0.5); }
            50% { opacity: var(--max-opacity); transform: scale(1); }
        }

        /* é˜¶æ®µå®¹å™¨ */
        .stage {
            position: absolute;
            width: 100%;
            height: 100vh;
            display: none;
            opacity: 0;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            transform-style: preserve-3d;
        }
        
        .stage.active {
            display: flex;
            opacity: 1; 
            z-index: 100; /* Ensure active stage is interactive */
        }

        /* è¿›åº¦æ¡ */
        .progress-container {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 300px;
            height: 4px;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            z-index: 1000;
            backdrop-filter: blur(5px);
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--secondary), var(--accent));
            width: 0%;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(255, 107, 107, 0.5);
            transition: width 0.5s ease;
        }

        /* é€šç”¨æ¯›ç»ç’ƒå¡ç‰‡ - å¢å¼º3Dæ„Ÿ */
        .glass-card {
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37), 0 0 0 1px rgba(255,255,255,0.1) inset;
            text-align: center;
            transform-style: preserve-3d;
            min-width: 300px;
            transition: transform 0.1s;
        }

        /* æŒ‰é’®æ ·å¼ */
        .btn-glow {
            padding: 12px 35px;
            font-size: 1.1rem;
            border: none;
            border-radius: 50px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            font-family: 'Orbitron', sans-serif;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-top: 20px;
            outline: none;
            /* Ensure button is clickable */
            position: relative;
            z-index: 5000;
            pointer-events: auto;
            transform: translateZ(30px); 
        }
        
        .btn-glow:hover {
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 0 20px rgba(255, 107, 107, 0.6);
        }
        
        .btn-glow:active {
            transform: translateY(1px) scale(0.95);
        }

        /* æ•…éšœæ–‡å­—ç‰¹æ•ˆ */
        .glitch-text {
            font-family: 'Orbitron', sans-serif;
            font-size: 2.5rem;
            position: relative;
            background: linear-gradient(to right, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            background-clip: text; /* Standard property */
            -webkit-text-fill-color: transparent;
            text-shadow: 2px 2px 10px rgba(255, 107, 107, 0.5);
        }

        /* 3D è¾“å…¥æ¡† */
        .input-group {
            position: relative;
            margin: 30px 0;
            transform-style: preserve-3d; /* Restored for 3D depth */
        }

        .input-3d {
            width: 200px;
            padding: 15px;
            font-size: 1.8rem;
            text-align: center;
            background: rgba(0,0,0,0.3);
            border: 2px solid var(--glass-border);
            border-radius: 15px;
            color: var(--primary);
            outline: none;
            transition: all 0.3s;
            font-family: 'Orbitron', monospace;
            letter-spacing: 5px;
            transform: translateZ(30px); /* Bring forward to ensure clickability */
            position: relative;
            z-index: 5000;
            pointer-events: auto;
        }

        .input-3d:focus {
            border-color: var(--primary);
            box-shadow: 0 0 15px rgba(255, 107, 107, 0.3);
            width: 220px;
        }

        /* é¼ æ ‡æ‹–å°¾ */
        .cursor-trail {
            position: fixed;
            width: 10px;
            height: 10px;
            background: white;
            border-radius: 50%;
            pointer-events: none;
            z-index: 9999;
            mix-blend-mode: screen;
            transition: transform 0.1s;
            box-shadow: 0 0 10px white, 0 0 20px var(--primary);
        }

        /* ç¤¼ç›’ä¼˜åŒ– */
        .gift-container {
            position: relative;
            width: 200px;
            height: 200px;
            cursor: pointer;
            perspective: 1000px;
            margin: 0 auto;
            transform-style: preserve-3d;
        }
        
        .gift-box {
            width: 100%;
            height: 100%;
            position: relative;
            transform-style: preserve-3d;
            transition: transform 0.1s;
        }

        /* ç¥ç¦è¯­äº‘ */
        .wishes-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            perspective: 1000px;
            overflow: hidden;
            pointer-events: none; /* Let clicks pass through for interaction */
        }
        
        /* Interactive clickable area needed for wishes */
        .wish-tag {
            position: absolute;
            color: white;
            font-weight: bold;
            text-shadow: 0 0 10px rgba(255,255,255,0.5);
            cursor: pointer;
            padding: 10px 20px;
            background: rgba(255,255,255,0.1);
            border-radius: 20px;
            backdrop-filter: blur(2px);
            white-space: nowrap;
            pointer-events: auto; /* Re-enable clicks */
            transition: transform 0.3s;
        }
        
        .wish-tag:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.2) translateZ(50px);
            z-index: 100;
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.4);
        }

        /* éŸ³æ•ˆæ§åˆ¶ */
        .sound-toggle {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            background: rgba(255,255,255,0.1);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 1001;
            font-size: 1.5rem;
            backdrop-filter: blur(5px);
            border: 1px solid var(--glass-border);
        }

        .sound-toggle:hover {
            background: rgba(255,255,255,0.2);
        }

        /* ç²’å­è„‰å†²åŠ¨ç”» */
        .pulse-ring {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            border-radius: 50%;
            border: 2px solid var(--accent);
            opacity: 0;
            pointer-events: none;
            animation: pulse-ring-anim 2s infinite;
        }
        
        @keyframes pulse-ring-anim {
            0% { width: 0; height: 0; opacity: 1; stroke-width: 5px; }
            100% { width: 400px; height: 400px; opacity: 0; stroke-width: 0; }
        }
        .sound-toggle:hover {
            background: rgba(255,255,255,0.2);
        }

        /* FIX: Simplify Password Stage 3D Context */
        #stagePassword {
            z-index: 2000; /* Above everything else */
        }
        #stagePassword .glass-card {
            transform-style: flat; /* Reduce 3D complexity for form stability */
        }
        #stagePassword .input-group {
            transform-style: flat;
        }
        #stagePassword input, #stagePassword button {
            transform: none !important; /* Remove 3D transforms from interactive elements */
            pointer-events: auto !important;
        }

        /* FIX: Simplify Wishing Well Stage 3D Context */
        #stage5 {
            z-index: 2000;
        }
        #stage5 .glass-card {
            transform-style: flat;
        }
        #stage5 button {
            transform: none !important;
            pointer-events: auto !important;
        }
        #wishingWell {
            pointer-events: auto !important;
        }

        /* FIX: Gift Stage (stage0) */
        #stage0 {
            z-index: 2000;
        }
        #stage0 .gift-container {
            pointer-events: auto !important;
        }

        /* FIX: Music Stage (stage6) */
        #stage6 {
            z-index: 2000;
        }
        #stage6 .glass-card {
            transform-style: flat;
        }
        #stage6 button {
            transform: none !important;
            pointer-events: auto !important;
        }
        #stage6 button {
            transform: none !important;
            pointer-events: auto !important;
        }

        /* Mobile Optimization */
        @media (max-width: 768px) {
            .wish-tag {
                font-size: 0.9rem !important; /* Smaller text */
                padding: 6px 14px !important;
                white-space: normal !important; /* Allow wrapping if really needed */
                max-width: 150px;
                text-align: center;
            }
            #bdayTitle {
                font-size: 4rem !important; /* Smaller title */
            }
            #bdayName {
                font-size: 2.5rem !important;
            }
            .btn-glow {
                padding: 10px 25px !important;
                font-size: 1rem !important;
            }
            h1 { font-size: 2rem !important; }
            h2 { font-size: 1.8rem !important; }
        }
    </style>
</head>
<body>

    <!-- åŠ¨æ€èƒŒæ™¯ -->
    <div class="stars-bg" id="starsBg"></div>
    <!-- Cursor trail particles are created dynamically by JS, no static element needed -->

    <!-- è¿›åº¦æ¡ -->
    <div class="progress-container">
        <div class="progress-bar" id="progressBar"></div>
    </div>

    <!-- Stage -1: å¯†ç è§£é” (é£æ ¼æ›´æ–°: å¹½é»˜ + 3Däº¤äº’) -->
    <div id="stagePassword" class="stage active">
        <div class="glass-card" id="passwordCard">
            <h1 class="glitch-text" data-text="é¢œå€¼æ£€æµ‹ä¸­å¿ƒ">é¢œå€¼æ£€æµ‹ä¸­å¿ƒ</h1>
            <p style="margin: 20px 0; color: rgba(255,255,255,0.7); font-size: 1.2rem;">éé»„é¢–æœ¬äººè¯·å‹¿å…¥å†…</p>
            
            <div class="input-group">
                <input type="text" id="passwordInput" class="input-3d" maxlength="4" placeholder="æ ¸å¿ƒä»£ç ">
            </div>
            
            <button class="btn-glow" onclick="checkPassword()">éªŒè¯é¢œå€¼</button>
            <div id="passwordHint" style="margin-top: 20px; min-height: 25px; color: var(--primary); font-weight: bold; text-shadow: 0 0 5px var(--primary);"></div>
            
            <p style="margin-top: 30px; font-size: 0.8rem; opacity: 0.5;">æç¤º: å…¨å¹´è®¸æ„¿æœ€çµéªŒçš„æ—¥å­ (å†œå†)</p>
        </div>
    </div>

    <!-- Stage 0: ç¤¼ç›’ -->
    <div id="stage0" class="stage">
        <div class="glass-card" style="background: transparent; border: none; box-shadow: none;">
            <div class="gift-container" id="giftContainer" onclick="openGift()">
                <div class="gift-box" id="giftBox">
                    <div style="position: absolute; width: 100%; height: 100%; background: linear-gradient(135deg, #6c5ce7, #a29bfe); border-radius: 20px; box-shadow: 0 0 50px rgba(108, 92, 231, 0.4);"></div>
                    <div style="position: absolute; top: 0; left: 50%; transform: translateX(-50%); width: 30px; height: 100%; background: #ffd700; box-shadow: 0 0 10px rgba(255, 215, 0, 0.5);"></div>
                    <div style="position: absolute; top: 50%; left: 0; transform: translateY(-50%); width: 100%; height: 30px; background: #ffd700; box-shadow: 0 0 10px rgba(255, 215, 0, 0.5);"></div>
                    <div id="giftLid" style="position: absolute; top: -10px; left: -10px; width: 220px; height: 40px; background: #a29bfe; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.2);"></div>
                </div>
            </div>
            <h2 class="glitch-text" style="margin-top: 60px; font-size: 2.5rem; text-shadow: 0 0 20px rgba(255,255,255,0.3);">æ£€æµ‹åˆ°è¶…çº§æƒŠå–œ</h2>
            <p style="color: rgba(255,255,255,0.8); margin-top: 10px; font-size: 1.2rem;" id="giftText">ç‚¹å‡»é¢†å–æœ¬å¹´åº¦æœ€ä½³è¿æ°”</p>
        </div>
    </div>

    <!-- Stage 2: åº†ç¥æ—¶åˆ» -->
    <div id="stage2" class="stage">
        <div style="text-align: center; z-index: 10; pointer-events: none;">
            <h1 class="glitch-text" id="bdayTitle" style="font-size: 6rem; line-height: 1.2; margin-bottom: 20px; opacity: 0; text-shadow: 0 0 30px rgba(255, 107, 107, 0.8);">
                ç”Ÿæ—¥<br>å¿«ä¹
            </h1>
            <h2 id="bdayName" style="font-size: 3.5rem; color: var(--secondary); font-family: 'Noto Sans SC', sans-serif; opacity: 0; transform: translateY(20px); text-shadow: 0 0 20px var(--secondary);">é»„é¢–</h2>
            <p style="margin-top: 40px; opacity: 0.8; font-size: 1.2rem; background: rgba(0,0,0,0.3); padding: 5px 15px; border-radius: 20px; display: inline-block;">ç‚¹å‡»å±å¹•ï¼Œé‡Šæ”¾ä½ çš„å¿«ä¹èƒ½é‡ï¼</p>
        </div>
    </div>

    <!-- Stage 3: ç¥ç¦å¢™ -->
    <div id="stage3" class="stage">
         <div class="wishes-container" id="wishesContainer">
             <!-- JS will inject wishes here -->
         </div>
         <div style="position: fixed; bottom: 80px; text-align: center; z-index: 100;">
             <!-- Corrected index: switch to stage5 (index 4) -->
             <button class="btn-glow" onclick="switchStage(4)">å‰å¾€ç¥ç§˜è®¸æ„¿æ± </button>
         </div>
    </div>

    <!-- Stage 5: è®¸æ„¿æ±  (å‡çº§ç‰ˆ) -->
    <div id="stage5" class="stage">
        <div class="glass-card">
            <h2>âœ¨ é“¶æ²³è®¸æ„¿æ±  âœ¨</h2>
            <p style="opacity: 0.7; margin-bottom: 20px;">å¬è¯´åœ¨è¿™é‡Œè®¸æ„¿ï¼Œè¿æš´å¯Œçš„æ¦‚ç‡éƒ½ä¼šå¢åŠ  99%</p>
            
            <div id="wishingWellWrapper" style="position: relative; width: 320px; height: 320px; margin: 20px auto;">
                <div class="pulse-ring"></div>
                <div class="pulse-ring" style="animation-delay: 1s;"></div>
                <div id="wishingWell" style="width: 100%; height: 100%; border-radius: 50%; 
                                             background: radial-gradient(circle, #000 0%, #1a237e 100%); 
                                             position: relative; overflow: hidden; cursor: pointer;
                                             box-shadow: 0 0 50px rgba(26, 35, 126, 0.8);
                                             border: 2px solid rgba(255,255,255,0.1);" 
                     onclick="throwCoin()">
                     <div id="ripples"></div>
                     <div style="position: absolute; bottom: 40px; width: 100%; text-align: center; opacity: 0.6; font-size: 0.9rem;">ğŸ‘‡ ç‚¹å‡»æŠ•å¸ ğŸ‘‡</div>
                </div>
            </div>
            
            <p id="wishFeedback" style="color: var(--secondary); height: 30px; margin-top: 10px; font-weight: bold; font-size: 1.2rem; text-shadow: 0 0 10px var(--secondary); opacity: 0;">&nbsp;</p>
            
            <div style="display: flex; gap: 20px; justify-content: center; margin-top: 20px;">
                <!-- Corrected index: switch to stage6 (index 5) -->
                <button class="btn-glow" onclick="switchStage(5)">è†å¬ä¸“å±æ—‹å¾‹</button>
            </div>
        </div>
    </div>

    <!-- Stage 6: éŸ³ä¹ç›’ (Visualizer Upgrade) -->
    <div id="stage6" class="stage">
        <div class="glass-card">
            <h2>ä¸“å±ç”Ÿæ—¥æ­Œ</h2>
            <p style="color: rgba(255,255,255,0.6); margin-top: 10px;">ç”±ä»£ç ç”Ÿæˆçš„çº¯å‡€æ—‹å¾‹</p>
            
            <div class="music-visualizer" id="visualizer" style="height: 180px; display: flex; align-items: center; justify-content: center; gap: 8px; margin: 40px 0;">
                <!-- Bars generated by JS -->
            </div>
            
            <button class="btn-glow" id="playMusicBtn" onclick="playMusic()">â–¶ æ’­æ”¾æ—‹å¾‹</button>
            <br>
            <!-- Replay: switch to stage3 (index 3) -->
            <button class="btn-glow" style="margin-top: 20px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.2);" onclick="switchStage(3)">å†ç©ä¸€æ¬¡</button>
        </div>
    </div>

    <script>
        // Store stages in order
        const stages = ['stagePassword', 'stage0', 'stage2', 'stage3', 'stage5', 'stage6'];
        let soundEnabled = false;

        // --- Init ---
        window.addEventListener('load', () => {
            initStars();
            initCursorTrail();
            gsap.to('#stagePassword', { opacity: 1, display: 'flex', duration: 1 });
            
            // Generate visualizer bars with gradient colors
            const vis = document.getElementById('visualizer');
            for(let i=0; i<15; i++) {
                const bar = document.createElement('div');
                bar.className = 'bar';
                bar.style.width = '10px';
                bar.style.height = '20px';
                bar.style.background = `hsl(${i * 24}, 100%, 70%)`;
                bar.style.borderRadius = '5px';
                bar.style.boxShadow = `0 0 10px hsl(${i * 24}, 100%, 70%)`;
                vis.appendChild(bar);
            }
            
            // Global 3D Parallax on cards (disabled for password stage)
            document.addEventListener('mousemove', (e) => {
                const x = (window.innerWidth / 2 - e.clientX) / 40;
                const y = (window.innerHeight / 2 - e.clientY) / 40;
                
                // Parallax Stars (always on)
                gsap.to('.stars-bg', {x: x * 0.5, y: y * 0.5, duration: 1});
                
                // Tilt active card - ONLY for non-interactive stages (celebration & wishes wall)
                const activeStage = document.querySelector('.stage.active');
                const noTiltStages = ['stagePassword', 'stage0', 'stage5', 'stage6'];
                if(activeStage && !noTiltStages.includes(activeStage.id)) {
                    const activeCard = activeStage.querySelector('.glass-card');
                    if(activeCard) {
                        gsap.to(activeCard, {
                            rotateY: x * -0.5,
                            rotateX: y * 0.5,
                            duration: 0.5,
                            ease: 'power1.out'
                        });
                    }
                }
            });
        });

        // --- Stars Background (Enhanced) ---
        function initStars() {
            const container = document.getElementById('starsBg');
            for(let i=0; i<150; i++) {
                const star = document.createElement('div');
                star.className = 'star';
                star.style.left = Math.random() * 100 + '%';
                star.style.top = Math.random() * 100 + '%';
                const size = Math.random() * 3 + 1;
                star.style.width = size + 'px';
                star.style.height = size + 'px';
                star.style.setProperty('--duration', (Math.random() * 2 + 1) + 's');
                star.style.setProperty('--max-opacity', Math.random() * 0.8 + 0.2);
                
                // Some stars are colored
                if(Math.random() > 0.8) {
                    star.style.background = 'var(--accent)';
                    star.style.boxShadow = '0 0 5px var(--accent)';
                }
                
                container.appendChild(star);
            }
        }

        // --- Cursor Trail (Particle Stream - Disabled for Password) ---
        function initCursorTrail() {
            let throttle = 0;
            document.addEventListener('mousemove', (e) => {
                // ONLY create particles if NOT on password stage
                const activeStage = document.querySelector('.stage.active');
                if (activeStage && activeStage.id === 'stagePassword') return;
                
                throttle++;
                if (throttle % 3 !== 0) return;

                const dot = document.createElement('div');
                dot.style.cssText = `
                    position: fixed; width: 6px; height: 6px; background: rgba(255,255,255,0.8);
                    border-radius: 50%; left: ${e.clientX}px; top: ${e.clientY}px; pointer-events: none;
                    z-index: 9999; box-shadow: 0 0 10px white;
                `;
                document.body.appendChild(dot);
                
                gsap.to(dot, {
                    scale: 0,
                    opacity: 0, 
                    duration: 0.5,
                    onComplete: () => dot.remove()
                });
            });
        }

        // --- Stage Management ---
        function switchStage(targetIndex) {
            if (targetIndex < 0 || targetIndex >= stages.length) return;
            const nextStageId = stages[targetIndex];
            const current = document.querySelector('.stage.active');
            const next = document.getElementById(nextStageId);

            if (current) {
                gsap.to(current, {
                    opacity: 0,
                    z: -500, // Move deeper into Z for transition
                    rotateX: 10,
                    duration: 0.6,
                    onComplete: () => {
                        current.classList.remove('active');
                        current.style.display = 'none';
                        showNextStage(next, nextStageId);
                    }
                });
            } else {
                showNextStage(next, nextStageId);
            }
            
            // Progress Bar Update
            const pct = (targetIndex / (stages.length - 1)) * 100;
            document.getElementById('progressBar').style.width = pct + '%';
        }

        function showNextStage(next, nextStageId) {
            next.style.display = 'flex';
            next.style.opacity = 0;
            next.style.transform = 'scale(1.2) translateY(50px)'; // Start slightly lower and larger
            next.classList.add('active');
            
            gsap.to(next, {
                opacity: 1,
                scale: 1,
                y: 0,
                rotateX: 0,
                z: 0,
                duration: 1,
                ease: 'power3.out'
            });
            
            if (nextStageId === 'stage0') initGiftStage();
            if (nextStageId === 'stage2') initFireworksStage();
            if (nextStageId === 'stage3') initWishesStage();
        }

        // --- Password Stage ---
        function checkPassword() {
            const input = document.getElementById('passwordInput');
            const hint = document.getElementById('passwordHint');
            const val = input.value;

            if (val === '1102') {
                hint.textContent = 'é¢œå€¼éªŒè¯é€šè¿‡ï¼ç¾å¥³è¯·è¿›...';
                hint.style.color = '#55efc4';
                // Success confetti
                confetti({ particleCount: 50, spread: 60, origin: { y: 0.7 } });
                
                gsap.to('#passwordCard', {
                    rotateY: 360, // Full spin
                    scale: 0,
                    opacity: 0,
                    duration: 1.2,
                    ease: 'back.in(2)',
                    onComplete: () => switchStage(1)
                });
            } else {
                const fails = [
                    'è­¦å‘Šï¼šé¢œå€¼æ•°æ®åŒ¹é…å¤±è´¥', 'ä½ æ˜¯è°ï¼Ÿè¿™ä¸æ˜¯ä½ è¯¥æ¥çš„åœ°æ–¹',
                    'å¯†ç é”™è¯¯ï¼Œè¯·ç¡®è®¤æ˜¯å¦ä¸ºç¾å¥³æœ¬äºº', 'å†è¯•ä¸€æ¬¡ï¼Œä¸ä»…è¦ç¾è¿˜è¦å¯¹'
                ];
                hint.textContent = fails[Math.floor(Math.random() * fails.length)];
                hint.style.color = 'var(--primary)';
                gsap.fromTo('#passwordCard', {x: -20}, {x: 20, duration: 0.08, repeat: 5, yoyo: true});
                input.value = '';
            }
        }
        document.getElementById('passwordInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') checkPassword();
        });

        // --- Gift Stage ---
        function initGiftStage() {
            gsap.fromTo('#giftBox', {y: -800, rotate: 360}, {y: 0, rotate: 0, duration: 1.5, ease: 'bounce.out'});
            
            // Interactive 3D Rotation on hover
            const box = document.getElementById('giftBox');
            box.addEventListener('mousemove', (e) => {
               const b = box.getBoundingClientRect();
               const x = (e.clientX - b.left - b.width/2) / 5;
               const y = (e.clientY - b.top - b.height/2) / 5;
               gsap.to(box, {rotateY: x, rotateX: -y, duration: 0.5});
            });
            box.addEventListener('mouseleave', () => {
                gsap.to(box, {rotateY: 0, rotateX: 0, duration: 0.5});
            });
        }

        function openGift() {
            // Dramatic opening
            gsap.timeline()
                .to('#giftBox', {scale: 0.9, duration: 0.2})
                .to('#giftBox', {scale: 1.1, duration: 0.1})
                .to('#giftLid', {y: -500, rotate: 120, opacity: 0, duration: 0.8, ease: 'power2.out'}, '-=0.1')
                .call(() => {
                    confetti({ particleCount: 150, spread: 100, origin: { y: 0.6 }, colors: ['#ffd700', '#ff6b6b'] });
                })
                .to('#giftBox', {opacity: 0, scale: 2, duration: 0.5, delay: 0.5, onComplete: () => switchStage(2)});
        }

        // --- Fireworks Stage ---
        function initFireworksStage() {
            const tl = gsap.timeline();
            tl.to('#bdayTitle', {opacity: 1, scale: 1.1, duration: 1, ease: 'elastic.out(1, 0.3)'})
              .to('#bdayTitle', {rotate: 2, yoyo: true, repeat: -1, duration: 2, ease: 'sine.inOut'})
              .to('#bdayName', {opacity: 1, y: 0, duration: 1}, '-=0.5');

            document.addEventListener('click', (e) => {
                if (document.querySelector('#stage2.active')) {
                    // Firework burst at click position
                    confetti({
                        particleCount: 60, spread: 70, 
                        origin: { x: e.clientX / window.innerWidth, y: e.clientY / window.innerHeight }
                    });
                    
                    // Ripple DOM effect (creating elements on fly)
                    const ripple = document.createElement('div');
                    ripple.style.cssText = `position:fixed; left:${e.clientX}px; top:${e.clientY}px; width:0; height:0; border:2px solid white; border-radius:50%; transform:translate(-50%,-50%); pointer-events:none;`;
                    document.body.appendChild(ripple);
                    gsap.to(ripple, {width: 200, height: 200, opacity: 0, duration: 0.8, onComplete: () => ripple.remove()});
                }
            });
            
            // Auto flashy background for party feel
            gsap.to('#stage2', {background: 'radial-gradient(circle, rgba(20,20,50,0.5), rgba(0,0,0,0))', yoyo: true, repeat: -1, duration: 1});

            setTimeout(() => switchStage(3), 8000);
        }

        // --- Wishes Stage ---
        function initWishesStage() {
            const container = document.getElementById('wishesContainer');
            const wishes = [
                'ç”Ÿæ—¥å¿«ä¹ï¼ğŸ‚', 'æ°¸è¿œ18å² ğŸ’ƒ', 'å‘è´¢æš´å¯Œ ğŸ’°', 'åƒä¸èƒ–ä½“è´¨ ğŸ”', 'æ¡ƒèŠ±æœµæœµå¼€ ğŸŒ¸', 
                'ä»Šå¤©ä½ æœ€å¤§ ğŸ‘‘', 'é¢œå€¼çˆ†è¡¨ âœ¨', 'ä½ å¯ä»¥æ°¸è¿œç›¸ä¿¡é»„é¢–', 'æ²‰è¿·èµšé’± ğŸ’¸', 'å‰ç¨‹ä¼¼é”¦ ğŸŒŸ',
                'å¥¶èŒ¶è‡ªç”± ğŸ¥¤', 'æ‰€æœ‰çš„å‘éƒ½å®Œç¾é¿å¼€', 'å‡ºé—¨æ¡åˆ°é’±', 'å¤´å‘æµ“å¯†', 'ç¬‘å£å¸¸å¼€ ğŸ˜„',
                'æƒ³å»å“ªå°±å»å“ª âœˆï¸', 'ä¸ä»…ä»…æ˜¯ç¾', 'æ‰åæ¨ªæº¢', 'æ¬§æ°”æ»¡æ»¡', 'å¿«ä¹æ˜Ÿçƒå±…æ°‘'
            ];

            container.innerHTML = '';
            wishes.forEach((text) => {
                const el = document.createElement('div');
                el.className = 'wish-tag';
                el.textContent = text;
                
                // Responsive Spread: Tighter range on mobile
                const isMobile = window.innerWidth < 768;
                const rangeX = isMobile ? 60 : 80; // Reduce from 80% to 60% on mobile
                const rangeY = isMobile ? 70 : 80;
                
                const x = (Math.random() - 0.5) * rangeX;
                const y = (Math.random() - 0.5) * rangeY;
                const z = Math.random() * 500 - 250;
                el.style.left = `50%`;
                el.style.top = `50%`;
                
                // Initial placement
                gsap.set(el, {x: x + 'vw', y: y + 'vh', z: z, opacity: 0});
                container.appendChild(el);
                
                // Enhanced Float animation
                gsap.to(el, {
                    opacity: 1,
                    z: z + 300,
                    rotationX: Math.random() * 20 - 10,
                    rotationY: Math.random() * 20 - 10,
                    duration: Math.random() * 5 + 5,
                    repeat: -1,
                    yoyo: true,
                    ease: 'sine.inOut',
                    delay: Math.random() * 2
                });
                
                el.addEventListener('click', (e) => {
                   e.stopPropagation(); // prevent underlying clicks
                   confetti({ particleCount: 30, spread: 40, origin: { x: e.clientX/window.innerWidth, y: e.clientY/window.innerHeight } });
                   gsap.to(el, {scale: 1.5, color: '#feca57', textShadow: '0 0 20px gold', duration: 0.2, yoyo: true, repeat: 1});
                });
            });
        }

        // --- Well Stage ---
        function throwCoin() {
            const coin = document.createElement('div');
            coin.style.cssText = 'position:absolute; width: 40px; height: 40px; background: radial-gradient(circle at 30% 30%, #ffd700, #b8860b); border-radius: 50%; top: -60px; left: 50%; z-index: 20; box-shadow: 0 0 15px gold; transform:translateX(-50%)';
            document.getElementById('wishingWellWrapper').appendChild(coin);
            
            gsap.to(coin, {
                top: '50%',
                scale: 0.1,
                rotateY: 720, // Spin while falling
                duration: 1,
                ease: 'power2.in',
                onComplete: () => {
                    coin.remove();
                    
                    // Ripple
                    const ripple = document.createElement('div');
                    ripple.style.cssText = 'position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); border: 3px solid rgba(72, 219, 251, 0.9); border-radius: 50%; width: 0; height: 0; box-shadow: 0 0 30px rgba(72, 219, 251, 0.6);';
                    document.getElementById('wishingWell').appendChild(ripple);
                    gsap.to(ripple, {width: 400, height: 400, opacity: 0, borderWidth: 0, duration: 1.5, onComplete: () => ripple.remove()});
                    
                    // Feedback
                    const msgs = ['æš´å¯Œ +1', 'ç¾è²Œ +1', 'æ™ºæ…§ +1', 'è¿æ°” +1', 'å¿ƒæ„¿è¾¾æˆ âœ¨', 'æœªæ¥å¯æœŸ ğŸš€'];
                    const msg = msgs[Math.floor(Math.random() * msgs.length)];
                    const fb = document.getElementById('wishFeedback');
                    fb.textContent = msg;
                    gsap.fromTo(fb, {opacity: 0, y: 10, scale: 0.8}, {opacity: 1, y: 0, scale: 1.2, duration: 0.5, ease: 'back.out'});
                    
                    // Particles
                    confetti({
                        particleCount: 40, spread: 50, startVelocity: 40,
                        origin: { y: 0.7 }, colors: ['#48dbfb', '#fff']
                    });
                }
            });
        }

        // --- Music Stage ---
        let audioCtx;
        function playMusic() {
            if (!audioCtx) {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                audioCtx = new AudioContext();
            }
            if (audioCtx.state === 'suspended') audioCtx.resume();

            const btn = document.getElementById('playMusicBtn');
            btn.textContent = "â™« æ­£åœ¨æ¼”å¥...";
            btn.disabled = true;

            const notes = { 'G4': 392.00, 'A4': 440.00, 'B4': 493.88, 'C5': 523.25, 'D5': 587.33, 'E5': 659.25, 'F5': 698.46, 'G5': 783.99, 'C6': 1046.50 };
            const song = [
                ['G4', 0.5], ['G4', 0.5], ['A4', 1], ['G4', 1], ['C5', 1], ['B4', 2],
                ['G4', 0.5], ['G4', 0.5], ['A4', 1], ['G4', 1], ['D5', 1], ['C5', 2],
                ['G4', 0.5], ['G4', 0.5], ['G5', 1], ['E5', 1], ['C5', 1], ['B4', 1], ['A4', 1],
                ['F5', 0.5], ['F5', 0.5], ['E5', 1], ['C5', 1], ['D5', 1], ['C5', 3]
            ];

            let currentTime = audioCtx.currentTime;
            song.forEach(([note, duration]) => {
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.type = 'sine'; // Sine for pure tone, or 'triangle' for 8-bit feel
                osc.frequency.setValueAtTime(notes[note], currentTime);
                gain.gain.setValueAtTime(0, currentTime);
                gain.gain.linearRampToValueAtTime(0.2, currentTime + 0.1);
                gain.gain.exponentialRampToValueAtTime(0.01, currentTime + duration - 0.1);
                osc.connect(gain);
                gain.connect(audioCtx.destination);
                osc.start(currentTime);
                osc.stop(currentTime + duration);
                currentTime += duration;
            });
            
            animateVisualizer();
            setTimeout(() => {
                btn.textContent = "â–¶ æ’­æ”¾æ—‹å¾‹";
                btn.disabled = false;
            }, currentTime * 1000 - (audioCtx.currentTime * 1000));
        }

        function animateVisualizer() {
            const bars = document.querySelectorAll('#visualizer .bar');
            if(document.querySelector('#stage6.active')) {
                bars.forEach(bar => {
                    gsap.to(bar, {
                        height: Math.random() * 100 + 20 + 'px',
                        duration: 0.15,
                        ease: 'power1.inOut'
                    });
                });
                requestAnimationFrame(animateVisualizer);
            }
        }
    </script>
</body>
</html>
